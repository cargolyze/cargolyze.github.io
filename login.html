<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cargolyze - Login | Shipment Tracking Automation</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
      	    --slate-grey: #37474f;
      	    --industrial-orange: #ff5722;
            --light-slate-grey: #546e7a;
            --primary-blue: #1e3a8a;
            --primary-light: #3b82f6;
            --accent-orange: #f97316;
            --accent-red: #ef4444;
            --dark-blue: #0f172a;
            --slate-dark: #334155;
            --slate-medium: #64748b;
            --slate-light: #cbd5e1;
            --white: #ffffff;
            --light-bg: #f8fafc;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.15);
            --radius: 16px;
            --radius-sm: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Montserrat', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        /* Animated background elements */
        .bg-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            overflow: hidden;
        }

        .ship-icon {
            position: absolute;
            font-size: 24px;
            color: rgba(59, 130, 246, 0.15);
            animation: float 20s linear infinite;
        }

        .ship-icon:nth-child(1) {
            top: 10%;
            left: -50px;
            animation-delay: 0s;
        }

        .ship-icon:nth-child(2) {
            top: 30%;
            right: -50px;
            animation-delay: 5s;
            animation-duration: 25s;
        }

        .ship-icon:nth-child(3) {
            top: 60%;
            left: -50px;
            animation-delay: 10s;
            animation-duration: 30s;
        }

        .container-icon {
            position: absolute;
            font-size: 16px;
            color: rgba(249, 115, 22, 0.1);
            animation: float 15s linear infinite reverse;
        }

        .container-icon:nth-child(4) {
            top: 20%;
            right: -30px;
            animation-delay: 2s;
        }

        .container-icon:nth-child(5) {
            top: 70%;
            right: -30px;
            animation-delay: 8s;
        }

        @keyframes float {
            0% {
                transform: translateX(-100px) rotate(0deg);
            }
            100% {
                transform: translateX(calc(100vw + 100px)) rotate(360deg);
            }
        }

        .auth-container {
            width: 100%;
            max-width: 480px;
            z-index: 1;
        }

        .auth-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: var(--radius);
            padding: 2.5rem;
            box-shadow: var(--shadow-xl);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }

        .auth-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-blue), var(--accent-orange));
        }

        /* Logo Styles */
        .logo-container {
            text-align: center;
            margin-bottom: 2rem;
        }

        .logo-main {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 1rem;
        }

        .logo-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.4rem;
            position: relative;
            overflow: hidden;
            transform: scale(1.2);
        }

        .logo-text {
            font-size: 2rem;
            font-weight: 800;
            background: var(--industrial-orange); /*linear-gradient(90deg, var(--primary-blue), var(--accent-orange));*/
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
        }

        .tagline {
            color: var(--slate-medium);
            font-size: 0.9rem;
            font-weight: 500;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            margin-top: 4px;
            opacity: 0.9;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .auth-title {
            font-size: 1.6rem;
            color: var(--slate-grey);
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        .auth-subtitle {
            color: var(--slate-medium);
            font-size: 0.95rem;
            margin-bottom: 0.5rem;
        }

        /* Tabs */
        .auth-tabs {
            display: flex;
            background: var(--light-bg);
            border-radius: var(--radius-sm);
            padding: 6px;
            margin-bottom: 2rem;
            position: relative;
        }

        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 0.85rem;
            background: transparent;
            border: none;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--slate-medium);
            cursor: pointer;
            border-radius: 6px;
            z-index: 2;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); /* Smoother transition */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab-indicator {
            position: absolute;
            top: 6px;
            left: 6px;
            height: calc(100% - 12px);
            width: calc(50% - 6px);
            background: var(--white);
            border-radius: 6px;
            box-shadow: var(--shadow-sm);
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); /* Smoother animation */
        }

        .auth-tab.active {
            color: var(--primary-blue);
        }

        /* Forms Container */
        .forms-container {
            position: relative;
            min-height: 400px; /* Set fixed height to prevent layout shift */
        }

        /* Forms */
        .auth-form {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
        }

        .auth-form.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
            position: relative;
            pointer-events: all;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--slate-dark);
            font-size: 0.9rem;
        }

        .form-label a {
            color: var(--primary-blue);
            text-decoration: none;
            font-weight: 500;
            font-size: 0.85rem;
            transition: color 0.3s;
        }

        .form-label a:hover {
            color: var(--accent-orange);
            text-decoration: underline;
        }

        .input-with-icon {
            position: relative;
        }

        .input-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--slate-medium);
            font-size: 1.1rem;
            z-index: 1;
        }

        .form-input {
            width: 100%;
            padding: 1rem 1rem 1rem 3rem;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.3s ease;
            background: var(--white);
            color: var(--slate-dark);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }

        .form-input::placeholder {
            color: var(--slate-light);
            font-weight: 400;
        }

        .password-input {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--slate-medium);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 4px;
            transition: all 0.3s;
            z-index: 1;
        }

        .password-toggle:hover {
            color: var(--primary-blue);
        }

        /* Google Button - Shipping Theme */
        .google-button {
            width: 100%;
            padding: 1rem;
            background: var(--white);
            color: var(--slate-dark);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .google-button:hover {
            background: #f8f9fa;
            border-color: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .google-button:active {
            transform: translateY(0);
        }

        .google-icon {
            width: 20px;
            height: 20px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="%234285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="%2334A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="%23FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="%23EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>') no-repeat center;
            background-size: contain;
        }

        .divider {
            display: flex;
            align-items: center;
            margin: 1.5rem 0;
            color: var(--slate-medium);
            font-size: 0.9rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 2px;
            background: var(--border-color);
        }

        .divider span {
            padding: 0 1rem;
            /*background: var(--white);*/
        }

        /* Auth Button - Shipping Theme */
        .auth-button {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(90deg, var(--primary-blue), var(--primary-light));
            color: var(--white);
            border: none;
            border-radius: var(--radius-sm);
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 0.5rem;
            position: relative;
            overflow: hidden;
            letter-spacing: 0.5px;
        }

        .auth-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s;
        }

        .auth-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(30, 58, 138, 0.3);
            background: linear-gradient(90deg, var(--primary-light), var(--primary-blue));
        }

        .auth-button:hover::before:not(:disabled) {
            left: 100%;
        }

        .auth-button:disabled {
            background: var(--slate-medium);
            cursor: not-allowed;
            opacity: 0.7;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 1.5rem 0;
        }

        .checkbox-container input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary-blue);
            cursor: pointer;
        }

        .checkbox-container label {
            font-size: 0.9rem;
            color: var(--slate-dark);
            cursor: pointer;
            line-height: 1.4;
        }

        .checkbox-container a {
            color: var(--primary-blue);
            text-decoration: none;
            font-weight: 600;
        }

        .checkbox-container a:hover {
            text-decoration: underline;
            color: var(--accent-orange);
        }

        /* Messages */
        .message {
            padding: 1rem;
            border-radius: var(--radius-sm);
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
            display: none;
            animation: slideIn 0.3s ease;
            font-weight: 500;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
            display: block;
        }

        .message.error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
            border: 1px solid rgba(239, 68, 68, 0.3);
            display: block;
        }

        .message.warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
            display: block;
        }

        .auth-footer {
            text-align: center;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
            font-size: 0.9rem;
            color: var(--slate-medium);
        }

        .auth-footer a {
            color: var(--primary-blue);
            text-decoration: none;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .auth-footer a:hover {
            color: var(--accent-orange);
            gap: 10px;
        }

        .auth-footer a i {
            font-size: 0.9rem;
            transition: transform 0.3s;
        }

        .auth-footer a:hover i {
            transform: translateX(-3px);
        }

        .debug-info {
            background: var(--light-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 0.75rem;
            margin-top: 1rem;
            font-size: 0.75rem;
            color: var(--slate-medium);
            display: none;
            font-family: 'Courier New', monospace;
        }

        /* Progress bar for loading */
        .progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-blue), var(--accent-orange));
            transition: width 0.3s;
            opacity: 0;
            transition: width 0.3s, opacity 0.3s;
        }

        .progress-bar.active {
            opacity: 1;
        }

        /* Responsive */
        @media (max-width: 480px) {
            .auth-card {
                padding: 2rem 1.5rem;
            }
            
            .logo-text {
                font-size: 1.8rem;
            }
            
            .tagline {
                font-size: 0.8rem;
            }
            
            .auth-title {
                font-size: 1.4rem;
            }
            
            .forms-container {
                min-height: 380px; /* Slightly smaller for mobile */
            }
        }

        /* Spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Animated background with shipping icons -->
    <div class="bg-container">
        <i class="fas fa-ship ship-icon"></i>
        <i class="fas fa-ship ship-icon"></i>
        <i class="fas fa-ship ship-icon"></i>
        <i class="fas fa-ship ship-icon"></i>
        <i class="fas fa-ship ship-icon"></i>
    </div>
    
    <div class="auth-container">
        <div class="auth-card">
            <!-- Progress bar -->
            <div class="progress-bar" id="progressBar"></div>
            
            <!-- Logo -->
            <div class="logo-container">
                <div class="logo-main">
                    <div class="logo-icon">
			<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 		   viewBox="0 0 24 24" style="enable-background:new 0 0 24 24;" xml:space="preserve">
			   <style type="text/css">
			   .st0{fill:#37474F;}
			   .st1{fill:#FF5722;}
			</style>
			<g>
			   <g>
			      <polygon class="st0" points="17.74,6.46 0.04,6.46 0.04,17.54 17.74,17.54 12.21,12"/>
			      <rect x="17.74" y="6.46" class="st0" width="0.01" height="11.07"/>
			      <polygon class="st1" points="12.21,12 17.74,17.54 17.74,6.46"/>
			  </g>
			  <rect x="19.53" y="9.79" class="st1" width="4.43" height="4.43"/>
		      </g>
		      </svg>
                    </div>
                    <div class="logo-text">CARGOLYZE</div>
                </div>
                <div class="tagline">SHIPMENT TRACKING AUTOMATION</div>
            </div>

            <div class="auth-header">
                <h1 class="auth-title" id="headerText">Welcome</h1>
                <p class="auth-subtitle" id="statusText">Register your credentials</p>
            </div>

            <!-- Tabs -->
            <div class="auth-tabs">
                <div class="tab-indicator" id="tabIndicator" style="transform: translateX(calc(100% + 6px));"></div>
                <button class="auth-tab" data-tab="login" id="loginTab">
                    <i class="fas fa-sign-in-alt"></i>
                    <span>Login</span>
                </button>
                <button class="auth-tab active" data-tab="signup" id="signupTab">
                    <i class="fas fa-user-plus"></i>
                    <span>Register</span>
                </button>
            </div>

            <!-- Messages -->
            <div class="message" id="message"></div>
            <div class="debug-info" id="debugInfo"></div>

            <!-- Google Sign-In -->
            <button class="google-button">
                <span class="google-icon"></span>
                <span id="googleBtnText">Register with Google</span>
            </button>

            <div class="divider" id="dividerText">
                <span>Or Register with Email</span>
            </div>

            <!-- Forms Container -->
            <div class="forms-container">
                <!-- Login Form -->
                <form id="loginForm" class="auth-form">
                    <div class="form-group">
                        <label class="form-label" for="loginEmail">
                            <span><i class="fas fa-id-badge"></i> Email ID</span>
                            <a href="reset-password.html" id="forgotPassword">Forgot Password?</a>
                        </label>
                        <div class="input-with-icon">
                            <i class="fas fa-envelope input-icon"></i>
                            <input type="email" id="loginEmail" class="form-input" placeholder="name@example.com" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="loginPassword">
                            <span><i class="fas fa-key"></i> Password</span>
                        </label>
                        <div class="password-input">
                            <div class="input-with-icon">
                                <i class="fas fa-lock input-icon"></i>
                                <input type="password" id="loginPassword" class="form-input" placeholder="Enter password" required>
                            </div>
                            <button type="button" class="password-toggle" data-target="loginPassword">
                                <i class="far fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <button type="submit" class="auth-button" id="loginButton">
                        <span id="loginButtonText">
                            <!-- <i class="fas fa-map-marker-alt"></i> --> Login
                        </span>
                    </button>
                </form>

                <!-- Signup Form -->
                <form id="signupForm" class="auth-form active">
                    <div class="form-group">
                        <label class="form-label" for="signupName">
                            <span><i class="fas fa-user"></i> User Name</span>
                        </label>
                        <div class="input-with-icon">
                            <i class="fas fa-circle-user input-icon"></i>
                            <input type="text" id="signupName" class="form-input" placeholder="Enter company name" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="signupEmail">
                            <span><i class="fas fa-id-badge"></i> Email ID</span>
                        </label>
                        <div class="input-with-icon">
                            <i class="fas fa-envelope input-icon"></i>
                            <input type="email" id="signupEmail" class="form-input" placeholder="name@company.com" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="signupPassword">
                            <span><i class="fas fa-key"></i> Password</span>
                        </label>
                        <div class="password-input">
                            <div class="input-with-icon">
                                <i class="fas fa-lock input-icon"></i>
                                <input type="password" id="signupPassword" class="form-input" placeholder="Create password" required minlength="8">
                            </div>
                            <button type="button" class="password-toggle" data-target="signupPassword">
                                <i class="far fa-eye"></i>
                            </button>
                        </div>
                        <small style="color: var(--slate-medium); font-size: 0.8rem; margin-top: 4px; display: block;">
                            <i class="fas fa-info-circle"></i> Minimum 8 characters for security compliance
                        </small>
                    </div>

                    <div class="checkbox-container">
                        <input type="checkbox" id="termsCheckbox" required>
                        <label for="termsCheckbox">
                            I agree to <a href="terms.html" target="_blank">Terms of Service</a> & 
                            <a href="privacy.html" target="_blank">Privacy Policy</a>
                        </label>
                    </div>

                    <button type="submit" class="auth-button" id="signupButton">
                        <span id="signupButtonText">
                            <!-- <i class="fas fa-anchor"></i> --> Register
                        </span>
                    </button>
                </form>
            </div>

            <div class="auth-footer">
                <p>
                    <a href="index.html">
                        <i class="fas fa-arrow-left"></i>
                        <span>Return to Homepage</span>
                    </a>
                </p>
                <p style="margin-top: 8px; font-size: 0.8rem; opacity: 0.8;">
                    <i class="fas fa-globe"></i> Global Logistics Network
                </p>
            </div>
        </div>
    </div>

<!-- Supabase -->
<script src="js/config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ========== SUPABASE CONFIGURATION ==========
const SUPABASE_URL = CONFIG.SUPABASE_URL;
const SUPABASE_KEY = CONFIG.SUPABASE_ANON_KEY;

//let supabase;

// ========== INITIALIZATION ==========
function initializeSupabase() {
    try {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        console.log('Supabase initialized for Cargolyze');
        return true;
    } catch (error) {
        console.error('Supabase initialization failed:', error);
        showMessage('Logistics service unavailable. Please refresh.', 'error');
        return false;
    }
}

// ========== DOM ELEMENTS ==========
const loginTab = document.getElementById('loginTab');
const signupTab = document.getElementById('signupTab');
const tabIndicator = document.getElementById('tabIndicator');
const messageDiv = document.getElementById('message');
const statusText = document.getElementById('statusText');
const headerText = document.getElementById('headerText');
const googleBtnText = document.getElementById('googleBtnText');
const dividerText = document.getElementById('dividerText');
const progressBar = document.getElementById('progressBar');
const formsContainer = document.querySelector('.forms-container');

// ========== TAB MANAGEMENT ==========
function switchTab(tabName) {
    // Update URL hash without reloading
    window.location.hash = tabName;
    console.log(`Switching to ${tabName === 'login' ? 'Login' : 'Registration'} tab`);
    
    // Update tabs
    [loginTab, signupTab].forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.auth-form').forEach(form => form.classList.remove('active'));
    
    if (tabName === 'login') {
        loginTab.classList.add('active');
        tabIndicator.style.transform = 'translateX(0)';
        googleBtnText.textContent = 'Login with Google';
        dividerText.textContent = 'Or login with email';
        headerText.textContent = 'Welcome';
        statusText.textContent = 'Sign in to access your logistics dashboard';
        
        // Fade in login form
        setTimeout(() => {
            document.getElementById('loginForm').classList.add('active');
        }, 50);
    } else {
        signupTab.classList.add('active');
        tabIndicator.style.transform = 'translateX(calc(100% + 6px))';
        googleBtnText.textContent = 'Register with Google';
        dividerText.textContent = 'Or register with email';
        headerText.textContent = 'Welcome';
        statusText.textContent = 'Register your credentials';
        
        // Fade in signup form
        setTimeout(() => {
            document.getElementById('signupForm').classList.add('active');
        }, 50);
    }
    
    showMessage('');
}

// Tab click handlers
loginTab.addEventListener('click', () => switchTab('login'));
signupTab.addEventListener('click', () => switchTab('signup'));

// ========== PASSWORD TOGGLE ==========
document.querySelectorAll('.password-toggle').forEach(button => {
    button.addEventListener('click', () => {
        const targetId = button.dataset.target;
        const input = document.getElementById(targetId);
        const icon = button.querySelector('i');
        
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    });
});

// ========== MESSAGING SYSTEM ==========
function showMessage(text, type = 'error', debug = '') {
    messageDiv.textContent = text;
    messageDiv.className = 'message';
    
    if (text && type) {
        messageDiv.classList.add(type);
    }
    
    if (debug) {
        document.getElementById('debugInfo').textContent = debug;
        document.getElementById('debugInfo').style.display = 'block';
    } else {
        document.getElementById('debugInfo').style.display = 'none';
    }
    
    // Auto-hide success messages
    if (type === 'success') {
        setTimeout(() => showMessage(''), 5000);
    }
}

// ========== LOADING STATES ==========
function setButtonLoading(buttonId, isLoading) {
    const button = document.getElementById(buttonId);
    const buttonText = document.getElementById(`${buttonId}Text`);
    
    if (isLoading) {
        button.disabled = true;
        buttonText.innerHTML = '<div class="spinner"></div>';
        
        // Show progress bar with smooth transition
        progressBar.style.opacity = '1';
        progressBar.classList.add('active');
        progressBar.style.width = '100%';
    } else {
        button.disabled = false;
        
        // Reset progress bar with smooth transition
        setTimeout(() => {
            progressBar.style.width = '0';
            setTimeout(() => {
                progressBar.style.opacity = '0';
                progressBar.classList.remove('active');
            }, 300);
        }, 100);
        
        if (buttonId === 'loginButton') {
            buttonText.innerHTML = 'Login';
        } else {
            buttonText.innerHTML = 'Register';
        }
    }
}

// ========== SESSION MANAGEMENT ==========
async function checkExistingSession() {
    // This function is only used to check if we should auto-redirect
    // Not used during initialization anymore
    return false;
}

// ========== GOOGLE AUTHENTICATION ==========
document.querySelector('.google-button').addEventListener('click', async () => {
    if (!supabase) {
        showMessage('Service temporarily unavailable. Please refresh.', 'error');
        return;
    }
    
    try {
        console.log('Initiating Google authentication...');
        showMessage('Connecting to Google services...', 'warning');
        
        const { error } = await supabase.auth.signInWithOAuth({
            provider: 'google',
            options: {
                redirectTo: `${window.location.origin}/dashboard.html`,
                queryParams: {
                    access_type: 'offline',
                    prompt: 'consent'
                }
            }
        });
        
        if (error) throw error;
        
    } catch (error) {
        console.error('Google authentication failed:', error);
        showMessage(`Authentication error: ${error.message}`, 'error');
    }
});

// ========== LOGIN FORM ==========
document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (!supabase) {
        showMessage('Authentication service not ready.', 'error');
        return;
    }
    
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;
    
    if (!email || !password) {
        showMessage('Please enter user credentials', 'error');
        return;
    }
    
    setButtonLoading('loginButton', true);
    
    try {
        console.log(`Login attempt for user: ${email}`);
        
        const { data, error } = await supabase.auth.signInWithPassword({
            email,
            password
        });
        
        if (error) throw error;
        
        console.log('âœ… Login successful:', data.user.email);
        showMessage(`Access granted! Loading dashboard...`, 'success');
        
        // Get user data from Supabase
        const name = data.user.user_metadata?.full_name || email.split('@')[0];
        const userData = {
            name: name,
            email: data.user.email,
            id: data.user.id,
            company: data.user.user_metadata?.full_name || name,
            role: 'carrier',
            loginTime: new Date().toISOString()
        };
        
        // Store in localStorage for quick access
        localStorage.setItem('cargolyze_user', JSON.stringify(userData));
        
        // Notify other tabs
        window.postMessage('userLoggedIn', '*');
        
        // Redirect to dashboard
        setTimeout(() => {
            window.location.href = 'dashboard.html';
        }, 1500);
        
    } catch (error) {
        console.error('Login failed:', error);
        
        let errorMessage = 'Access denied. ';
        if (error.message.includes('Invalid login credentials')) {
            errorMessage += 'Invalid Email ID or Password.';
        } else if (error.message.includes('Email not confirmed')) {
            errorMessage += 'Please verify your email first.';
        } else {
            errorMessage += error.message;
        }
        
        showMessage(errorMessage, 'error');
    } finally {
        setButtonLoading('loginButton', false);
    }
});

// ========== REGISTRATION FORM ==========
document.getElementById('signupForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (!supabase) {
        showMessage('Registration service not ready.', 'error');
        return;
    }
    
    const company = document.getElementById('signupName').value.trim();
    const email = document.getElementById('signupEmail').value.trim();
    const password = document.getElementById('signupPassword').value;
    const termsAccepted = document.getElementById('termsCheckbox').checked;
    
    // Validation
    if (!company || !email || !password) {
        showMessage('Please complete all registration fields', 'error');
        return;
    }
    
    if (password.length < 8) {
        showMessage('Password must be at least 8 characters', 'error');
        return;
    }
    
    if (!termsAccepted) {
        showMessage('Please accept terms and conditions', 'error');
        return;
    }
    
    setButtonLoading('signupButton', true);
    
    try {
        console.log(`Registration: ${company} (${email})`);
        
        const { data, error } = await supabase.auth.signUp({
            email,
            password,
            options: {
                data: {
                    full_name: company,
                    user_type: 'user'
                },
                emailRedirectTo: `${window.location.origin}/dashboard.html`
            }
        });
        
        if (error) throw error;
        
        console.log('Registration successful:', data);
        
        if (data.user?.identities?.length === 0) {
            showMessage('User already registered. Please sign in.', 'error');
        } else {
            showMessage(
                `Registration successful! Welcome to Cargolyze, ${company}! Please check your email to complete verification.`,
                'success'
            );
            
            // Store temporary user data in localStorage
            const userData = {
                name: company,
                email: email,
                id: data.user?.id || 'pending',
                company: company,
                role: 'carrier',
                isPendingVerification: true
            };
            localStorage.setItem('cargolyze_user', JSON.stringify(userData));
            
            // Clear form and switch to login
            setTimeout(() => {
                switchTab('login');
                document.getElementById('loginEmail').value = email;
                document.getElementById('signupForm').reset();
            }, 3000);
        }
        
    } catch (error) {
        console.error('Registration failed:', error);
        showMessage(`Registration failed: ${error.message}`, 'error');
    } finally {
        setButtonLoading('signupButton', false);
    }
});

// ========== PASSWORD RECOVERY ==========
document.getElementById('forgotPassword')?.addEventListener('click', (e) => {
    e.preventDefault();
    const email = document.getElementById('loginEmail').value.trim();
    
    if (email) {
        // Validate email format
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (emailRegex.test(email)) {
            // Redirect with email as URL parameter
            const encodedEmail = encodeURIComponent(email);
            window.location.href = `reset-password.html?email=${encodedEmail}`;
            return;
        }
    }
    
    // If no valid email, redirect without parameter
    window.location.href = 'reset-password.html';
});

// ========== INITIALIZATION ==========
document.addEventListener('DOMContentLoaded', () => {
    console.log('ðŸš¢ Cargolyze Login Portal Initializing...');
    
    // Initialize Supabase
    if (initializeSupabase()) {
        console.log('âœ… Logistics services ready');
        
        // Check if user already has localStorage AND Supabase session
        checkUserAndRedirect();
    }
    
    // Handle URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const emailParam = urlParams.get('email');
    const action = urlParams.get('action');
    const message = urlParams.get('message');
    
    if (action === 'signup') {
        switchTab('signup');
    }
    
    if (message) {
        showMessage(decodeURIComponent(message), 'success');
    }

    // Check for hash in URL
    const hash = window.location.hash;
    
    if (hash === '#login') {
        switchTab('login');
    } else if (hash === '#signup') {
        switchTab('signup');
    } else if (action === 'signup') {
        switchTab('signup');
    } else {
        switchTab('signup'); // Default
    }

    if (emailParam) {
        const email = decodeURIComponent(emailParam);
        document.getElementById('signupEmail').value = email;
        console.log('ðŸ“§ Pre-filled email from URL:', email);
    }

    // Auto-focus on email input in signup form
    setTimeout(() => {
        document.getElementById('signupName')?.focus();
    }, 300);
});

// Check both localStorage and Supabase session
async function checkUserAndRedirect() {
    const storedUser = localStorage.getItem('cargolyze_user');
    
    if (!storedUser) {
        console.log('No user in localStorage');
        return; // Show login form
    }
    
    try {
        // Check if Supabase session is still valid
        const { data: { session }, error } = await supabase.auth.getSession();
        
        if (error) {
            console.error('Supabase session check error:', error);
            localStorage.removeItem('cargolyze_user');
            return; // Show login form
        }
        
        if (!session) {
            console.log('No valid Supabase session');
            localStorage.removeItem('cargolyze_user');
            return; // Show login form
        }
        
        // Both localStorage and Supabase session are valid
        console.log('âœ… User already logged in, redirecting to dashboard');
        window.location.href = 'dashboard.html';
        
    } catch (error) {
        console.error('Error checking user:', error);
        localStorage.removeItem('cargolyze_user');
    }
}

// ========== NOTIFY LOGIN FUNCTION ==========
function notifyLogin(userData) {
    localStorage.setItem('cargolyze_user', JSON.stringify(userData));
    
    // If this was opened in a new tab/window, update the opener
    if (window.opener) {
        window.opener.postMessage('userLoggedIn', '*');
    }
}

// Listen for login/logout messages
window.addEventListener('message', function(event) {
    if (event.data === 'userLoggedIn' || event.data === 'userLoggedOut') {
        // Refresh user state
        window.location.reload();
    }
});
</script>
</body>
</html>